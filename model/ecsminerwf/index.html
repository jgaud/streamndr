
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../getting_started/">
      
      
        <link rel="next" href="../minas/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.15">
    
    
      
        <title>ecsminerwf - StreamNDR Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.113286f1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#streamndr.model.ecsminerwf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="StreamNDR Docs" class="md-header__button md-logo" aria-label="StreamNDR Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            StreamNDR Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ecsminerwf
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="StreamNDR Docs" class="md-nav__button md-logo" aria-label="StreamNDR Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    StreamNDR Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        StreamNDR
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          API Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          API Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
          model
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          model
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ecsminerwf
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        ecsminerwf
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf" class="md-nav__link">
    streamndr.model.ecsminerwf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF" class="md-nav__link">
    ECSMinerWF
  </a>
  
    <nav class="md-nav" aria-label="ECSMinerWF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.confusion_matrix" class="md-nav__link">
    confusion_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.learn_many" class="md-nav__link">
    learn_many()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.learn_one" class="md-nav__link">
    learn_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.predict_many" class="md-nav__link">
    predict_many()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.predict_one" class="md-nav__link">
    predict_one()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../minas/" class="md-nav__link">
        minas
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
          utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utils/data_structure/" class="md-nav__link">
        data_structure
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf" class="md-nav__link">
    streamndr.model.ecsminerwf
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF" class="md-nav__link">
    ECSMinerWF
  </a>
  
    <nav class="md-nav" aria-label="ECSMinerWF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.confusion_matrix" class="md-nav__link">
    confusion_matrix()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.learn_many" class="md-nav__link">
    learn_many()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.learn_one" class="md-nav__link">
    learn_one()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.predict_many" class="md-nav__link">
    predict_many()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#streamndr.model.ecsminerwf.ECSMinerWF.predict_one" class="md-nav__link">
    predict_one()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>ecsminerwf</h1>

<div class="doc doc-object doc-module">


<a id="streamndr.model.ecsminerwf"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="streamndr.model.ecsminerwf.ECSMinerWF" class="doc doc-heading">
        <code>ECSMinerWF</code>


</h2>


  <div class="doc doc-contents ">
      <p class="doc doc-class-bases">
        Bases: <code><span title="river.base">base</span>.<span title="river.base.MiniBatchClassifier">MiniBatchClassifier</span></code></p>

  
      <p>Implementation of the ECSMinerWF (ECSMiner without feedback) algorithm for novelty detection.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>K</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of pseudopoints per classifier. In other words, it is the number of K cluster for the clustering algorithm.</p></td>
          <td>
                <code>50</code>
          </td>
        </tr>
        <tr>
          <td><code>min_examples_cluster</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Minimum number of examples to declare a novel class</p></td>
          <td>
                <code>50</code>
          </td>
        </tr>
        <tr>
          <td><code>ensemble_size</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of classifiers to use to create the ensemble</p></td>
          <td>
                <code>6</code>
          </td>
        </tr>
        <tr>
          <td><code>verbose</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Controls the level of verbosity, the higher, the more messages are displayed. Can be '1', '2', or '3'.</p></td>
          <td>
                <code>0</code>
          </td>
        </tr>
        <tr>
          <td><code>random_state</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Seed for the random number generation. Makes the algorithm deterministic if a number is provided.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>MAX_MEMORY_SIZE</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Constant used to determine the maximum number of rows used by numpy for the computation of the closest clusters. A higher number is faster but takes more memory.</p></td>
        </tr>
        <tr>
          <td><code>models</code></td>
          <td>
                <code>list of list of MicroCluster</code>
          </td>
          <td><p>List containing the models created in the offline phase. In other words, it contains multiple lists of MicroClusters.</p></td>
        </tr>
        <tr>
          <td><code>novel_models</code></td>
          <td>
                <code>list of MicroCluster</code>
          </td>
          <td><p>Contains the clusters representing novel classes, added during the online phase</p></td>
        </tr>
        <tr>
          <td><code>sample_counter</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Number of samples treated, used by the forgetting mechanism</p></td>
        </tr>
        <tr>
          <td><code>short_mem</code></td>
          <td>
                <code>list of ShortMemInstance</code>
          </td>
          <td><p>Buffer memory containing the samples labeled as unknown temporarily for the novelty detection process</p></td>
        </tr>
        <tr>
          <td><code>last_nd</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Timestamp when the last novelty detection was performed. Used to determine if a new novelty detection should be performed.</p></td>
        </tr>
        <tr>
          <td><code>before_offline_phase</code></td>
          <td>
                <code>bool</code>
          </td>
          <td><p>Whether or not the algorithm was initialized (offline phase). The algorithm needs to first be initialized to be used in an online fashion.</p></td>
        </tr>
    </tbody>
  </table>


        <details class="quote">
          <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ECSMinerWF</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">MiniBatchClassifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of the ECSMinerWF (ECSMiner without feedback) algorithm for novelty detection.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    K : int</span>
<span class="sd">        Number of pseudopoints per classifier. In other words, it is the number of K cluster for the clustering algorithm.</span>
<span class="sd">    min_examples_cluster : int</span>
<span class="sd">        Minimum number of examples to declare a novel class </span>
<span class="sd">    ensemble_size : int</span>
<span class="sd">        Number of classifiers to use to create the ensemble</span>
<span class="sd">    verbose : int</span>
<span class="sd">        Controls the level of verbosity, the higher, the more messages are displayed. Can be &#39;1&#39;, &#39;2&#39;, or &#39;3&#39;.</span>
<span class="sd">    random_state : int</span>
<span class="sd">        Seed for the random number generation. Makes the algorithm deterministic if a number is provided.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    MAX_MEMORY_SIZE : int</span>
<span class="sd">        Constant used to determine the maximum number of rows used by numpy for the computation of the closest clusters. A higher number is faster but takes more memory.</span>
<span class="sd">    models : list of list of MicroCluster</span>
<span class="sd">        List containing the models created in the offline phase. In other words, it contains multiple lists of MicroClusters.</span>
<span class="sd">    novel_models : list of MicroCluster</span>
<span class="sd">        Contains the clusters representing novel classes, added during the online phase</span>
<span class="sd">    sample_counter : int</span>
<span class="sd">        Number of samples treated, used by the forgetting mechanism</span>
<span class="sd">    short_mem : list of ShortMemInstance</span>
<span class="sd">        Buffer memory containing the samples labeled as unknown temporarily for the novelty detection process</span>
<span class="sd">    last_nd : int</span>
<span class="sd">        Timestamp when the last novelty detection was performed. Used to determine if a new novelty detection should be performed.</span>
<span class="sd">    before_offline_phase : bool</span>
<span class="sd">        Whether or not the algorithm was initialized (offline phase). The algorithm needs to first be initialized to be used in an online fashion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAX_MEMORY_SIZE</span> <span class="o">=</span> <span class="mi">50000</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">K</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                 <span class="n">min_examples_cluster</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1">#Number of instances requried to declare a novel class </span>
                 <span class="n">ensemble_size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> 
                 <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span> <span class="o">=</span> <span class="n">min_examples_cluster</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span> <span class="o">=</span> <span class="n">ensemble_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#Potential novel class instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_nd</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span> <span class="c1">#No novelty detection performed yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">before_offline_phase</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">learn_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function used by river algorithms to learn one sample. It is not applicable to this algorithm since the offline phase requires all samples</span>
<span class="sd">        to arrive at once. It is only added as to follow River&#39;s API.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : dict</span>
<span class="sd">            Sample</span>
<span class="sd">        y : int</span>
<span class="sd">            Label of the given sample</span>
<span class="sd">        w : float, optional</span>
<span class="sd">            Weight, not used, by default 1.0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Not applicable</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">learn_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents the offline phase of the algorithm. Receives a number of samples and their given labels and learns all of the known classes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas.DataFrame or numpy.ndarray</span>
<span class="sd">            Samples to be learned by the model</span>
<span class="sd">        y : list of int</span>
<span class="sd">            Labels corresponding to the given samples, must be the same length as the number of samples</span>
<span class="sd">        w : float, optional</span>
<span class="sd">            Weights, not used, by default 1.0</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ECSMinerWF</span>
<span class="sd">            Itself</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span><span class="p">)</span>

        <span class="c1"># in offline phase, consider all instances arriving at the same time in the microclusters:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="c1">#Separate data into (ensemble_size) chunks</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span><span class="p">):</span>
            <span class="n">X_chunk</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">]</span>
            <span class="n">y_chunk</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_microclusters</span><span class="p">(</span><span class="n">X_chunk</span><span class="p">,</span> <span class="n">y_chunk</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="c1">#As per ECSMiner paper, any microcluster with less than 3 instances is discarded</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">before_offline_phase</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents the online phase. Equivalent to predict_many() with only one sample. Receives only one sample, predict its label and adds </span>
<span class="sd">        it to the cluster if it is a known class. Otherwise, if it&#39;s unknown, it is added to the short term memory and novelty detection is </span>
<span class="sd">        performed once the trigger has been reached (min_examples_cluster).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : dict</span>
<span class="sd">            Sample</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Label predicted for the given sample, predicts -1 if labeled as unknown</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_many</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="kc">None</span><span class="p">,:])</span>


    <span class="k">def</span> <span class="nf">predict_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Represents the online phase. Receives multiple samples, for each sample predict its label and adds it to the cluster if it is a known class. </span>
<span class="sd">        Otherwise, if it&#39;s unknown, it is added to the short term memory and novelty detection is performed once the trigger has been reached (min_examples_cluster).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X : pandas.DataFrame or numpy.ndarray</span>
<span class="sd">            Samples</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">            Array of length len(X) containing the predicted labels, predicts -1 if the corresponding sample labeled as unknown</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If the model has not been trained first with learn_many() (offline phase)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_offline_phase</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1">#Converting DataFrame to numpy array</span>

        <span class="n">closest_model_cluster</span><span class="p">,</span> <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_majority_voting</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#We have novel clusters in our list</span>
            <span class="n">novel_closest_clusters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span>

        <span class="n">pred_label</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">closest_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_filter_buffer</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span> <span class="c1"># classify with the label from majority voting</span>
                <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">closest_cluster</span><span class="o">.</span><span class="n">update_cluster</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">):</span> <span class="c1">#One of our novel cluster can explain our sample</span>
                <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">update_cluster</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1">#Classify as unknown</span>
                <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ShortMemInstance</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_nd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span>

                    <span class="n">novel_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_novelty_detect</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">novel_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#We have novelty clusters</span>
                        <span class="k">for</span> <span class="n">novel_cluster</span> <span class="ow">in</span> <span class="n">novel_clusters</span><span class="p">:</span>
                            <span class="n">max_label_ensemble</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">model</span><span class="p">])</span>

                            <span class="n">max_label_novel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

                            <span class="n">novel_cluster</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_label_ensemble</span><span class="p">,</span> <span class="n">max_label_novel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Novel cluster detected: &quot;</span><span class="p">,</span> <span class="n">novel_cluster</span><span class="o">.</span><span class="n">small_str</span><span class="p">())</span>

                            <span class="c1">#Add novel cluster to our novel models list</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">novel_cluster</span><span class="p">)</span>

                            <span class="c1">#Remove instances from the buffer</span>
                            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">novel_cluster</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a confusion matrix.</span>

<span class="sd">        It must be run on a fitted classifier that has already seen the examples in the test set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        X_test : numpy.ndarray</span>
<span class="sd">            The set of data samples to predict the class labels for.</span>
<span class="sd">        y_test : numpy.ndarray</span>
<span class="sd">            The set of class labels for the data samples.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        river.metrics.ConfusionMatrix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">closest_model_cluster</span><span class="p">,</span> <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_majority_voting</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">ConfusionMatrix</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#We have novel clusters in our list</span>
            <span class="n">novel_closest_clusters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)):</span>
            <span class="n">closest_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span> <span class="c1"># classify with the label from majority voting</span>
                <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">):</span> <span class="c1">#One of our novel cluster can explain our sample</span>
                <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># classify as unknown</span>
                <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">conf_matrix</span>

    <span class="k">def</span> <span class="nf">_generate_microclusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">keep_instances</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">labels_</span>

        <span class="n">microclusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
            <span class="n">cluster_instances</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">microcluster</span><span class="p">]</span>
            <span class="n">y_cluster_instances</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="n">microcluster</span><span class="p">]</span>

            <span class="n">values</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_cluster_instances</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">most_common_y</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">counts</span><span class="p">)]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_instances</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_samples</span><span class="p">:</span>
                <span class="n">mc</span> <span class="o">=</span> <span class="n">MicroCluster</span><span class="p">(</span><span class="n">most_common_y</span><span class="p">,</span> <span class="n">instances</span><span class="o">=</span><span class="n">cluster_instances</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">keep_instances</span><span class="o">=</span><span class="n">keep_instances</span><span class="p">)</span>
                <span class="n">microclusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mc</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">microclusters</span>

    <span class="k">def</span> <span class="nf">_majority_voting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">closest_clusters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">closest_clusters_model</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="n">model</span><span class="p">])</span>
            <span class="n">closest_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">closest_clusters_model</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">model</span><span class="p">[</span><span class="n">closest_cluster</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">closest_cluster</span> <span class="ow">in</span> <span class="n">closest_clusters_model</span><span class="p">])</span>
            <span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> 

        <span class="n">best_models</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">closest_model_cluster</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
            <span class="n">closest_model_cluster</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">best_models</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">closest_clusters</span><span class="p">[</span><span class="n">best_models</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">closest_model_cluster</span><span class="p">,</span> <span class="p">[</span><span class="n">Counter</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">labels</span><span class="p">)]</span>


    <span class="k">def</span> <span class="nf">_get_closest_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">centroids</span><span class="p">):</span>   

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No clusters&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centroids</span><span class="p">)</span>
        <span class="n">norm_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">centroids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># Cut into batches if there are too many samples to save on memory</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ECSMinerWF</span><span class="o">.</span><span class="n">MAX_MEMORY_SIZE</span><span class="p">)):</span>
            <span class="n">sl</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="n">ECSMinerWF</span><span class="o">.</span><span class="n">MAX_MEMORY_SIZE</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ECSMinerWF</span><span class="o">.</span><span class="n">MAX_MEMORY_SIZE</span><span class="p">)</span>
            <span class="n">norm_dists</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">sl</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">centroids</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">norm_dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">norm_dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_novelty_detect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Novelty detection started&quot;</span><span class="p">)</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">instance</span><span class="o">.</span><span class="n">point</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="p">])</span>
        <span class="n">new_class_vote</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">#Creating F-pseudopoints</span>
        <span class="n">K0</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">))</span>
        <span class="n">K0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">K0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>

        <span class="n">f_microclusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_microclusters</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">keep_instances</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">f_microclusters_centroids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cl</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">f_microclusters</span><span class="p">])</span>

        <span class="n">potential_novel_clusters_idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Computing qNSC for each model in our ensemble</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">qnscs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qnsc</span><span class="p">(</span><span class="n">f_microclusters_centroids</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

            <span class="n">potential_clusters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">total_instances</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f_microcluster</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f_microclusters</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">qnscs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">potential_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_microcluster</span><span class="p">)</span>
                    <span class="n">total_instances</span> <span class="o">+=</span> <span class="n">f_microcluster</span><span class="o">.</span><span class="n">n</span>
                    <span class="n">potential_novel_clusters_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">total_instances</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span><span class="p">:</span> <span class="n">new_class_vote</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="k">if</span> <span class="n">new_class_vote</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="c1">#Get the indices of all clusters which had a positive qnsc for all models</span>
            <span class="n">novel_clusters_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">potential_novel_clusters_idx</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)]</span>
            <span class="n">novel_clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">f_microclusters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">novel_clusters_idx</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">novel_clusters</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_qnsc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudopoints</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="c1">#Calculate mean distance of all points between themselves</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pseudopoints</span> <span class="o">-</span> <span class="n">pseudopoints</span><span class="p">[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dists</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">mean_distances_between_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#Calculate minimum distance between points known cluster</span>
        <span class="n">all_centroids</span> <span class="o">=</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="n">model</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">minimum_distances_to_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">pseudopoints</span><span class="p">,</span> <span class="n">all_centroids</span><span class="p">)</span>

        <span class="n">qnscs</span> <span class="o">=</span> <span class="p">(</span><span class="n">minimum_distances_to_class</span> <span class="o">-</span> <span class="n">mean_distances_between_points</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">minimum_distances_to_class</span><span class="p">,</span> <span class="n">mean_distances_between_points</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qnscs</span>

    <span class="k">def</span> <span class="nf">_filter_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span> <span class="o">-</span> <span class="n">instance</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">):</span> <span class="c1">#We remove samples that have an age greater than the chunk size</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#No need to iterate over the whole buffer since older elements are at the beginning</span>
                <span class="k">break</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
        </details>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="streamndr.model.ecsminerwf.ECSMinerWF.confusion_matrix" class="doc doc-heading">
<code class="highlight language-python"><span class="n">confusion_matrix</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Creates a confusion matrix.</p>
<p>It must be run on a fitted classifier that has already seen the examples in the test set.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X_test</code></td>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The set of data samples to predict the class labels for.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y_test</code></td>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>The set of class labels for the data samples.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>river.<span title="river.metrics">metrics</span>.<span title="river.metrics.ConfusionMatrix">ConfusionMatrix</span></code>
          </td>
          <td></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">confusion_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a confusion matrix.</span>

<span class="sd">    It must be run on a fitted classifier that has already seen the examples in the test set.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X_test : numpy.ndarray</span>
<span class="sd">        The set of data samples to predict the class labels for.</span>
<span class="sd">    y_test : numpy.ndarray</span>
<span class="sd">        The set of class labels for the data samples.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    river.metrics.ConfusionMatrix</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">closest_model_cluster</span><span class="p">,</span> <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_majority_voting</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
    <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">ConfusionMatrix</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#We have novel clusters in our list</span>
        <span class="n">novel_closest_clusters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_test</span><span class="p">)):</span>
        <span class="n">closest_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span> <span class="c1"># classify with the label from majority voting</span>
            <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">):</span> <span class="c1">#One of our novel cluster can explain our sample</span>
            <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># classify as unknown</span>
            <span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">conf_matrix</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conf_matrix</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="streamndr.model.ecsminerwf.ECSMinerWF.learn_many" class="doc doc-heading">
<code class="highlight language-python"><span class="n">learn_many</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Represents the offline phase of the algorithm. Receives a number of samples and their given labels and learns all of the known classes.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
                <code>pandas.DataFrame or numpy.ndarray</code>
          </td>
          <td><p>Samples to be learned by the model</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code>list of int</code>
          </td>
          <td><p>Labels corresponding to the given samples, must be the same length as the number of samples</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>w</code></td>
          <td>
                <code>float, optional</code>
          </td>
          <td><p>Weights, not used, by default 1.0</p></td>
          <td>
                <code>1.0</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="streamndr.model.ecsminerwf.ECSMinerWF" href="#streamndr.model.ecsminerwf.ECSMinerWF">ECSMinerWF</a></code>
          </td>
          <td><p>Itself</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">learn_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the offline phase of the algorithm. Receives a number of samples and their given labels and learns all of the known classes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas.DataFrame or numpy.ndarray</span>
<span class="sd">        Samples to be learned by the model</span>
<span class="sd">    y : list of int</span>
<span class="sd">        Labels corresponding to the given samples, must be the same length as the number of samples</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        Weights, not used, by default 1.0</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ECSMinerWF</span>
<span class="sd">        Itself</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span><span class="p">)</span>

    <span class="c1"># in offline phase, consider all instances arriving at the same time in the microclusters:</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="c1">#Separate data into (ensemble_size) chunks</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_size</span><span class="p">):</span>
        <span class="n">X_chunk</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">]</span>
        <span class="n">y_chunk</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_microclusters</span><span class="p">(</span><span class="n">X_chunk</span><span class="p">,</span> <span class="n">y_chunk</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span> <span class="c1">#As per ECSMiner paper, any microcluster with less than 3 instances is discarded</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">before_offline_phase</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="streamndr.model.ecsminerwf.ECSMinerWF.learn_one" class="doc doc-heading">
<code class="highlight language-python"><span class="n">learn_one</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Function used by river algorithms to learn one sample. It is not applicable to this algorithm since the offline phase requires all samples
to arrive at once. It is only added as to follow River's API.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>x</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>Sample</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>y</code></td>
          <td>
                <code>int</code>
          </td>
          <td><p>Label of the given sample</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>w</code></td>
          <td>
                <code>float, optional</code>
          </td>
          <td><p>Weight, not used, by default 1.0</p></td>
          <td>
                <code>1.0</code>
          </td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">learn_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function used by river algorithms to learn one sample. It is not applicable to this algorithm since the offline phase requires all samples</span>
<span class="sd">    to arrive at once. It is only added as to follow River&#39;s API.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : dict</span>
<span class="sd">        Sample</span>
<span class="sd">    y : int</span>
<span class="sd">        Label of the given sample</span>
<span class="sd">    w : float, optional</span>
<span class="sd">        Weight, not used, by default 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Not applicable</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="streamndr.model.ecsminerwf.ECSMinerWF.predict_many" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict_many</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Represents the online phase. Receives multiple samples, for each sample predict its label and adds it to the cluster if it is a known class. 
Otherwise, if it's unknown, it is added to the short term memory and novelty detection is performed once the trigger has been reached (min_examples_cluster).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
                <code>pandas.DataFrame or numpy.ndarray</code>
          </td>
          <td><p>Samples</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Array of length len(X) containing the predicted labels, predicts -1 if the corresponding sample labeled as unknown</p></td>
        </tr>
    </tbody>
  </table>

  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Exception</code>
          </td>
          <td><p>If the model has not been trained first with learn_many() (offline phase)</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the online phase. Receives multiple samples, for each sample predict its label and adds it to the cluster if it is a known class. </span>
<span class="sd">    Otherwise, if it&#39;s unknown, it is added to the short term memory and novelty detection is performed once the trigger has been reached (min_examples_cluster).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : pandas.DataFrame or numpy.ndarray</span>
<span class="sd">        Samples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Array of length len(X) containing the predicted labels, predicts -1 if the corresponding sample labeled as unknown</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        If the model has not been trained first with learn_many() (offline phase)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">before_offline_phase</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Model must be fitted first&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="c1">#Converting DataFrame to numpy array</span>

    <span class="n">closest_model_cluster</span><span class="p">,</span> <span class="n">y_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_majority_voting</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#We have novel clusters in our list</span>
        <span class="n">novel_closest_clusters</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_closest_clusters</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="n">microcluster</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">microcluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span>

    <span class="n">pred_label</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">closest_cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">closest_model_cluster</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_filter_buffer</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span> <span class="c1"># classify with the label from majority voting</span>
            <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_preds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">closest_cluster</span><span class="o">.</span><span class="n">update_cluster</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">distance_to_centroid</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">closest_cluster</span><span class="o">.</span><span class="n">max_distance</span><span class="p">):</span> <span class="c1">#One of our novel cluster can explain our sample</span>
            <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">[</span><span class="n">novel_closest_clusters</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">update_cluster</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="c1">#Classify as unknown</span>
            <span class="n">pred_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ShortMemInstance</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_nd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_examples_cluster</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_nd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_counter</span>

                <span class="n">novel_clusters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_novelty_detect</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">novel_clusters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#We have novelty clusters</span>
                    <span class="k">for</span> <span class="n">novel_cluster</span> <span class="ow">in</span> <span class="n">novel_clusters</span><span class="p">:</span>
                        <span class="n">max_label_ensemble</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">model</span><span class="p">])</span>

                        <span class="n">max_label_novel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">cluster</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

                        <span class="n">novel_cluster</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_label_ensemble</span><span class="p">,</span> <span class="n">max_label_novel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Novel cluster detected: &quot;</span><span class="p">,</span> <span class="n">novel_cluster</span><span class="o">.</span><span class="n">small_str</span><span class="p">())</span>

                        <span class="c1">#Add novel cluster to our novel models list</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">novel_models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">novel_cluster</span><span class="p">)</span>

                        <span class="c1">#Remove instances from the buffer</span>
                        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">novel_cluster</span><span class="o">.</span><span class="n">instances</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">short_mem</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_label</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h3 id="streamndr.model.ecsminerwf.ECSMinerWF.predict_one" class="doc doc-heading">
<code class="highlight language-python"><span class="n">predict_one</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Represents the online phase. Equivalent to predict_many() with only one sample. Receives only one sample, predict its label and adds 
it to the cluster if it is a known class. Otherwise, if it's unknown, it is added to the short term memory and novelty detection is 
performed once the trigger has been reached (min_examples_cluster).</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>X</code></td>
          <td>
                <code>dict</code>
          </td>
          <td><p>Sample</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>numpy.<span title="numpy.ndarray">ndarray</span></code>
          </td>
          <td><p>Label predicted for the given sample, predicts -1 if labeled as unknown</p></td>
        </tr>
    </tbody>
  </table>

      <details class="quote">
        <summary>Source code in <code>streamndr/model/ecsminerwf.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predict_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the online phase. Equivalent to predict_many() with only one sample. Receives only one sample, predict its label and adds </span>
<span class="sd">    it to the cluster if it is a known class. Otherwise, if it&#39;s unknown, it is added to the short term memory and novelty detection is </span>
<span class="sd">    performed once the trigger has been reached (min_examples_cluster).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : dict</span>
<span class="sd">        Sample</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.ndarray</span>
<span class="sd">        Label predicted for the given sample, predicts -1 if labeled as unknown</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_many</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">()))[</span><span class="kc">None</span><span class="p">,:])</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.2a6f1dda.min.js"></script>
      
    
  </body>
</html>